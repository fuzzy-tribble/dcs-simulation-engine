name: Deploy API

on:
    workflow_dispatch:
      inputs:
        experiment_id:    
            description: "Experiment ID to deploy (used in app name simulation-engine-api-<experiment_id>)"
            required: true
            default: "demo"
        game:
            description: "Which game should the api expose?"
            required: true
            default: "Explore"
        banner:
            description: "Banner message"
            required: false
            default: "<b>DEMO</b>"
        
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      PRIMARY_REGION: dfw
      GAME: ${{ github.event.inputs.game }}
      PORT: ${{ github.event.inputs.port }}
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Build fly config from inputs
        run: |
          cat > fly.generated.toml <<'TOML'
          app = 'simulation-api-${{ github.event.inputs.experiment_id }}'
          primary_region = '${{ env.PRIMARY_REGION }}'

          [build]

          [processes]
            web = 'poetry run python -m scripts.run_widget --source "simulation-api-${{ github.event.inputs.experiment_id }}" --game ${{ env.GAME }} --port ${{ env.PORT }} --host 0.0.0.0'

          [http_service]
            internal_port = ${{ env.PORT }}
            force_https = true
            auto_stop_machines = 'stop'
            auto_start_machines = true
            min_machines_running = 0
            processes = ['web']

          [[vm]]
            memory = '1gb'
            cpu_kind = 'shared'
            cpus = 1
          TOML

      - name: Deploy
        run: |
          flyctl deploy \
            --remote-only \
            --config fly.generated.toml \
            --app "${FLY_APP}"
            --env MONGO_URI="${{ secrets.MONGO_URI }}" \
            --env OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
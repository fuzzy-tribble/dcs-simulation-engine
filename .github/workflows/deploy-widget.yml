name: Deploy Widget

on:
    workflow_dispatch:
      inputs:
        experiment_id:    
            description: "Experiment ID to deploy (used in app name simulation-engine-<interface>-<experiment_id>)"
            required: true
            default: "demo"
        game_name:
            description: "Which game should the widget expose?"
            required: true
            default: "Explore"
        banner:
            description: "Banner message"
            required: false
            default: "<b>DEMO</b> This is a low fidelity demo."
        show_npc_selector:
            description: "Show the non-player character (NPC) selector in the widget?"
            required: false
            default: "true"
        show_pc_selector:
            description: "Show the player character (PC) selector in the widget?"
            required: false
            default: "true"
        port:
            description: "Port to run the interface on"
            required: false
            default: "8080"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      PRIMARY_REGION: dfw
      GAME_NAME: ${{ github.event.inputs.game_name }}
      BANNER: ${{ github.event.inputs.banner }}
      SHOW_NPC_SELECTOR: ${{ github.event.inputs.show_npc_selector }}
      SHOW_PC_SELECTOR: ${{ github.event.inputs.show_pc_selector }}
      PORT: ${{ github.event.inputs.port }}
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Build fly config from inputs
        run: |
          cat > fly.generated.toml <<'TOML'
          app = 'simulation-widget-${{ github.event.inputs.experiment_id }}'
          primary_region = '${{ env.PRIMARY_REGION }}'

          [build]

          [processes]
            web = 'poetry run python -m scripts.run_widget --source "simulation-widget-${{ github.event.inputs.experiment_id }}" --game-name ${{ env.GAME_NAME }} --port ${{ env.PORT }} --host 0.0.0.0 --banner "$${{ env.BANNER }}" --show-npc-selector ${{ env.SHOW_NPC_SELECTOR }} --show-pc-selector ${{ env.SHOW_PC_SELECTOR }}'

          [http_service]
            internal_port = ${{ env.PORT }}
            force_https = true
            auto_stop_machines = 'stop'
            auto_start_machines = true
            min_machines_running = 0
            processes = ['web']

          [[vm]]
            memory = '1gb'
            cpu_kind = 'shared'
            cpus = 1
          TOML
      - name: Launch or attach to Fly app
        run: |
          if flyctl apps list | grep -q "simulation-widget-${{ github.event.inputs.experiment_id }}"; then
            echo "App exists, skipping creation."
          else
            flyctl apps create simulation-widget-${{ github.event.inputs.experiment_id }} --region ${{ env.PRIMARY_REGION }}
          fi
      - name: Deploy
        run: |
          flyctl deploy \
            --remote-only \
            --config fly.generated.toml \
            --app "${FLY_APP}" \
            --env MONGO_URI="${{ secrets.MONGO_URI }}" \
            --env OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \